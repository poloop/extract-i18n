{"version":3,"file":"extract-i18n.js","sources":["../src/language-files-parser.ts","../src/extract-i18n.ts"],"sourcesContent":["import * as path from 'path'\nimport * as fs from 'fs'\nimport glob from 'glob'\nimport isValidGlob from 'is-valid-glob'\nimport json5 from 'json5'\nimport Dot from 'dot-object'\n\nexport interface I18nObject {\n  [index: string]: string\n}\n\nexport interface I18nStructuredData {\n  [index: string]: string | I18nObject\n}\n\nexport type ParserOptions = {\n  languageFiles?: string,\n  encoding?: string\n}\n\ntype SimpleFile = {\n  fileName: string\n  path: string\n  content: I18nStructuredData\n}\n\nexport const defaultParserOptions: ParserOptions = {\n  languageFiles: './locale/**/*.?(json|json5)'\n}\n\nexport default class LanguageFilesParser {\n  \n  options: ParserOptions\n  \n  constructor(options: ParserOptions = defaultParserOptions) {\n    this.options = {\n      ...defaultParserOptions,\n      ...options\n    }\n  }\n\n  read(src: string | undefined): SimpleFile[] {\n    if (!isValidGlob(src)) {\n      throw new Error(\"languageFiles isn't a valid glob pattern.\");\n    }\n\n    // eslint-disable-next-line no-console\n    console.log(`Read data from \"${src}\"...`)\n\n    const targetFiles: string[] = glob.sync(src)\n\n    if (targetFiles.length === 0) {\n      throw new Error('languageFiles glob has no files.');\n    }\n  \n    return targetFiles.map((f: string) => {\n      const fullPath: string = path.resolve(process.cwd(), f)\n      const extension: string = path.extname(fullPath).toLowerCase()\n\n      let content: I18nStructuredData = {}\n      \n      switch (extension) {\n        case '.json':\n          content = JSON.parse(<string>fs.readFileSync(fullPath, 'utf8'))\n          break;\n        case '.json5':\n          content = json5.parse(<string>fs.readFileSync(fullPath, 'utf8'))\n          break;\n      }\n\n      return <SimpleFile>{\n        fileName: f.replace(process.cwd(), '.'),\n        path: f,\n        content\n      }\n    })\n  }\n\n  extract(languageFiles: (SimpleFile)[]): I18nStructuredData {\n    const localeDir = this.options.languageFiles?.split('**')[0]\n    if (!localeDir) {\n      throw new Error(\"languageFiles should be in a separate directory.\");\n    }\n    return languageFiles.reduce((acc: any, file: SimpleFile) => {\n      const i18nFileName: string = path.basename(file.fileName)\n\n      const regExp = new RegExp(`(?<=${localeDir})(.*?)(?=/)`)\n\n      const result = file.fileName.match(regExp)\n\n      const lang: string|null = result ? result[0] : null\n\n      if (!lang) {\n        throw new Error(\"languageFiles should be in a language directory named with the language code.\");\n      }\n      const i18nFileContent: I18nStructuredData = file.content\n\n      acc[lang] = {\n        ...(acc[lang] ?? {}), \n        [i18nFileName]: Dot.dot(i18nFileContent)\n      }\n\n      return acc\n    }, {})\n  }\n\n  getMissingKeys(data: I18nStructuredData): { lang: string, fileName: string, key: string }[] {\n    const missingKeys: { lang: string, fileName: string, key: string }[] = [] \n    Object.keys(data).forEach((lang: string) => {\n      Object.keys(data[lang]).forEach((file: string) => {\n        Object.keys((data[lang] as I18nStructuredData)[file]).forEach((key: string) => {\n          Object.keys(data).filter(lg => lg !== lang).forEach((otherLang: string) => {\n            if (!((data[otherLang] as I18nStructuredData)?.[file] as I18nObject)?.[key]) {\n              missingKeys.push({\n                lang: otherLang,\n                fileName: file,\n                key\n              })\n            }\n          })\n        }) \n      })\n    })\n    return missingKeys\n  }\n\n  getDuplicateKeys(data: I18nStructuredData): { content: string, lang: string, fileNames: string[], keys: string[]}[] {\n    const duplicateContents: { content: string, lang: string, file: string, key: string}[] = []\n    Object.keys(data).forEach((lang: string) => {\n      Object.keys(data[lang]).forEach((file: string) => {\n        Object.keys((data[lang] as I18nStructuredData)[file]).forEach((key: string) => {\n          duplicateContents.push({ content: ((data[lang] as I18nStructuredData)[file] as I18nObject)[key], lang, key, file})\n        })\n      })\n    })\n    const duplicateKeys = duplicateContents.reduce((acc: any, { content, lang, file, key }) => {\n      if (duplicateContents.filter(({content: contentToCheck}) => content === contentToCheck).length > 1) {\n        acc[content] = {content, lang, fileNames: [...(acc[content]?.fileNames ?? []), file], keys: [...(acc[content]?.keys ?? []), key]}\n      }\n      return acc\n    }, {})\n    return Object.values(duplicateKeys)\n  }\n}","\nimport LanguageFilesParser, { defaultParserOptions } from './language-files-parser'\n\nexport enum ReportActions {\n  MISSINGS = 'missings',\n  DUPLICATES = 'duplicates'\n}\n\nexport function createI18nReport(actions: ReportActions, languageFiles: string | undefined = defaultParserOptions.languageFiles) {\n  const parser = new LanguageFilesParser({ languageFiles })\n  const data = parser.extract(parser.read(parser.options.languageFiles)) \n\n  return {\n    missingKeys: (!actions || actions === ReportActions.MISSINGS) ? parser.getMissingKeys(data) : [],\n    duplicateKeys: (!actions || actions === ReportActions.DUPLICATES) ? parser.getDuplicateKeys(data) : [],\n  }\n}\n\nprocess.on('uncaughtException', (err) => {\n  // eslint-disable-next-line no-console\n  console.error('[extract-i18n]', err);\n  process.exit(1);\n});\n\nprocess.on('unhandledRejection', (err) => {\n  // eslint-disable-next-line no-console\n  console.error('[extract-i18n]', err);\n  process.exit(1);\n});"],"names":["defaultParserOptions","languageFiles","LanguageFilesParser","constructor","options","read","src","isValidGlob","Error","console","log","targetFiles","glob","sync","length","map","f","fullPath","path","resolve","process","cwd","extension","extname","toLowerCase","content","JSON","parse","fs","readFileSync","json5","fileName","replace","extract","localeDir","split","reduce","acc","file","i18nFileName","basename","regExp","RegExp","result","match","lang","i18nFileContent","Dot","dot","getMissingKeys","data","missingKeys","Object","keys","forEach","key","filter","lg","otherLang","push","getDuplicateKeys","duplicateContents","duplicateKeys","contentToCheck","fileNames","values","ReportActions","createI18nReport","actions","parser","MISSINGS","DUPLICATES","on","err","error","exit"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA0BO,MAAMA,oBAAoB,GAAkB;AACjDC,EAAAA,aAAa,EAAE;AADkC,CAA5C;MAIcC;AAInBC,EAAAA,YAAYC,UAAyBJ;SAFrCI;AAGE,SAAKA,OAAL,gBACKJ,oBADL,EAEKI,OAFL;AAID;;AAEDC,EAAAA,IAAI,CAACC,GAAD;AACF,QAAI,CAACC,+BAAW,CAACD,GAAD,CAAhB,EAAuB;AACrB,YAAM,IAAIE,KAAJ,CAAU,2CAAV,CAAN;AACD;;;AAGDC,IAAAA,OAAO,CAACC,GAAR,oBAA+BJ,SAA/B;AAEA,UAAMK,WAAW,GAAaC,wBAAI,CAACC,IAAL,CAAUP,GAAV,CAA9B;;AAEA,QAAIK,WAAW,CAACG,MAAZ,KAAuB,CAA3B,EAA8B;AAC5B,YAAM,IAAIN,KAAJ,CAAU,kCAAV,CAAN;AACD;;AAED,WAAOG,WAAW,CAACI,GAAZ,CAAiBC,CAAD;AACrB,YAAMC,QAAQ,GAAWC,eAAI,CAACC,OAAL,CAAaC,OAAO,CAACC,GAAR,EAAb,EAA4BL,CAA5B,CAAzB;AACA,YAAMM,SAAS,GAAWJ,eAAI,CAACK,OAAL,CAAaN,QAAb,EAAuBO,WAAvB,EAA1B;AAEA,UAAIC,OAAO,GAAuB,EAAlC;;AAEA,cAAQH,SAAR;AACE,aAAK,OAAL;AACEG,UAAAA,OAAO,GAAGC,IAAI,CAACC,KAAL,CAAmBC,aAAE,CAACC,YAAH,CAAgBZ,QAAhB,EAA0B,MAA1B,CAAnB,CAAV;AACA;;AACF,aAAK,QAAL;AACEQ,UAAAA,OAAO,GAAGK,yBAAK,CAACH,KAAN,CAAoBC,aAAE,CAACC,YAAH,CAAgBZ,QAAhB,EAA0B,MAA1B,CAApB,CAAV;AACA;AANJ;;AASA,aAAmB;AACjBc,QAAAA,QAAQ,EAAEf,CAAC,CAACgB,OAAF,CAAUZ,OAAO,CAACC,GAAR,EAAV,EAAyB,GAAzB,CADO;AAEjBH,QAAAA,IAAI,EAAEF,CAFW;AAGjBS,QAAAA;AAHiB,OAAnB;AAKD,KApBM,CAAP;AAqBD;;AAEDQ,EAAAA,OAAO,CAAChC,aAAD;;;AACL,UAAMiC,SAAS,4BAAG,KAAK9B,OAAL,CAAaH,aAAhB,qBAAG,sBAA4BkC,KAA5B,CAAkC,IAAlC,EAAwC,CAAxC,CAAlB;;AACA,QAAI,CAACD,SAAL,EAAgB;AACd,YAAM,IAAI1B,KAAJ,CAAU,kDAAV,CAAN;AACD;;AACD,WAAOP,aAAa,CAACmC,MAAd,CAAqB,CAACC,GAAD,EAAWC,IAAX;;;AAC1B,YAAMC,YAAY,GAAWrB,eAAI,CAACsB,QAAL,CAAcF,IAAI,CAACP,QAAnB,CAA7B;AAEA,YAAMU,MAAM,GAAG,IAAIC,MAAJ,QAAkBR,sBAAlB,CAAf;AAEA,YAAMS,MAAM,GAAGL,IAAI,CAACP,QAAL,CAAca,KAAd,CAAoBH,MAApB,CAAf;AAEA,YAAMI,IAAI,GAAgBF,MAAM,GAAGA,MAAM,CAAC,CAAD,CAAT,GAAe,IAA/C;;AAEA,UAAI,CAACE,IAAL,EAAW;AACT,cAAM,IAAIrC,KAAJ,CAAU,+EAAV,CAAN;AACD;;AACD,YAAMsC,eAAe,GAAuBR,IAAI,CAACb,OAAjD;AAEAY,MAAAA,GAAG,CAACQ,IAAD,CAAH,6BACMR,GAAG,CAACQ,IAAD,CADT,wBACmB,EADnB;AAEE,SAACN,YAAD,GAAgBQ,uBAAG,CAACC,GAAJ,CAAQF,eAAR;AAFlB;AAKA,aAAOT,GAAP;AACD,KApBM,EAoBJ,EApBI,CAAP;AAqBD;;AAEDY,EAAAA,cAAc,CAACC,IAAD;AACZ,UAAMC,WAAW,GAAsD,EAAvE;AACAC,IAAAA,MAAM,CAACC,IAAP,CAAYH,IAAZ,EAAkBI,OAAlB,CAA2BT,IAAD;AACxBO,MAAAA,MAAM,CAACC,IAAP,CAAYH,IAAI,CAACL,IAAD,CAAhB,EAAwBS,OAAxB,CAAiChB,IAAD;AAC9Bc,QAAAA,MAAM,CAACC,IAAP,CAAaH,IAAI,CAACL,IAAD,CAAJ,CAAkCP,IAAlC,CAAb,EAAsDgB,OAAtD,CAA+DC,GAAD;AAC5DH,UAAAA,MAAM,CAACC,IAAP,CAAYH,IAAZ,EAAkBM,MAAlB,CAAyBC,EAAE,IAAIA,EAAE,KAAKZ,IAAtC,EAA4CS,OAA5C,CAAqDI,SAAD;;;AAClD,gBAAI,qBAAGR,IAAI,CAACQ,SAAD,CAAP,qCAAG,gBAAyCpB,IAAzC,CAAH,aAAG,qBAAgEiB,GAAhE,CAAH,CAAJ,EAA6E;AAC3EJ,cAAAA,WAAW,CAACQ,IAAZ,CAAiB;AACfd,gBAAAA,IAAI,EAAEa,SADS;AAEf3B,gBAAAA,QAAQ,EAAEO,IAFK;AAGfiB,gBAAAA;AAHe,eAAjB;AAKD;AACF,WARD;AASD,SAVD;AAWD,OAZD;AAaD,KAdD;AAeA,WAAOJ,WAAP;AACD;;AAEDS,EAAAA,gBAAgB,CAACV,IAAD;AACd,UAAMW,iBAAiB,GAAkE,EAAzF;AACAT,IAAAA,MAAM,CAACC,IAAP,CAAYH,IAAZ,EAAkBI,OAAlB,CAA2BT,IAAD;AACxBO,MAAAA,MAAM,CAACC,IAAP,CAAYH,IAAI,CAACL,IAAD,CAAhB,EAAwBS,OAAxB,CAAiChB,IAAD;AAC9Bc,QAAAA,MAAM,CAACC,IAAP,CAAaH,IAAI,CAACL,IAAD,CAAJ,CAAkCP,IAAlC,CAAb,EAAsDgB,OAAtD,CAA+DC,GAAD;AAC5DM,UAAAA,iBAAiB,CAACF,IAAlB,CAAuB;AAAElC,YAAAA,OAAO,EAAIyB,IAAI,CAACL,IAAD,CAAJ,CAAkCP,IAAlC,EAAuDiB,GAAvD,CAAb;AAA0EV,YAAAA,IAA1E;AAAgFU,YAAAA,GAAhF;AAAqFjB,YAAAA;AAArF,WAAvB;AACD,SAFD;AAGD,OAJD;AAKD,KAND;AAOA,UAAMwB,aAAa,GAAGD,iBAAiB,CAACzB,MAAlB,CAAyB,CAACC,GAAD,EAAW;AAAEZ,MAAAA,OAAF;AAAWoB,MAAAA,IAAX;AAAiBP,MAAAA,IAAjB;AAAuBiB,MAAAA;AAAvB,KAAX;AAC7C,UAAIM,iBAAiB,CAACL,MAAlB,CAAyB,CAAC;AAAC/B,QAAAA,OAAO,EAAEsC;AAAV,OAAD,KAA+BtC,OAAO,KAAKsC,cAApE,EAAoFjD,MAApF,GAA6F,CAAjG,EAAoG;AAAA;;AAClGuB,QAAAA,GAAG,CAACZ,OAAD,CAAH,GAAe;AAACA,UAAAA,OAAD;AAAUoB,UAAAA,IAAV;AAAgBmB,UAAAA,SAAS,EAAE,CAAC,6CAAI3B,GAAG,CAACZ,OAAD,CAAP,qBAAI,aAAcuC,SAAlB,oCAA+B,EAA/B,CAAD,EAAqC1B,IAArC,CAA3B;AAAuEe,UAAAA,IAAI,EAAE,CAAC,0CAAIhB,GAAG,CAACZ,OAAD,CAAP,qBAAI,cAAc4B,IAAlB,gCAA0B,EAA1B,CAAD,EAAgCE,GAAhC;AAA7E,SAAf;AACD;;AACD,aAAOlB,GAAP;AACD,KALqB,EAKnB,EALmB,CAAtB;AAMA,WAAOe,MAAM,CAACa,MAAP,CAAcH,aAAd,CAAP;AACD;;;;AC3ISI;;AAAZ,WAAYA;AACVA,EAAAA,yBAAA,aAAA;AACAA,EAAAA,2BAAA,eAAA;AACD,CAHD,EAAYA,qBAAa,KAAbA,qBAAa,KAAA,CAAzB;;SAKgBC,iBAAiBC,SAAwBnE,gBAAoCD,oBAAoB,CAACC;AAChH,QAAMoE,MAAM,GAAG,IAAInE,mBAAJ,CAAwB;AAAED,IAAAA;AAAF,GAAxB,CAAf;AACA,QAAMiD,IAAI,GAAGmB,MAAM,CAACpC,OAAP,CAAeoC,MAAM,CAAChE,IAAP,CAAYgE,MAAM,CAACjE,OAAP,CAAeH,aAA3B,CAAf,CAAb;AAEA,SAAO;AACLkD,IAAAA,WAAW,EAAG,CAACiB,OAAD,IAAYA,OAAO,KAAKF,qBAAa,CAACI,QAAvC,GAAmDD,MAAM,CAACpB,cAAP,CAAsBC,IAAtB,CAAnD,GAAiF,EADzF;AAELY,IAAAA,aAAa,EAAG,CAACM,OAAD,IAAYA,OAAO,KAAKF,qBAAa,CAACK,UAAvC,GAAqDF,MAAM,CAACT,gBAAP,CAAwBV,IAAxB,CAArD,GAAqF;AAF/F,GAAP;AAID;AAED9B,OAAO,CAACoD,EAAR,CAAW,mBAAX,EAAiCC,GAAD;AAC9B;AACAhE,EAAAA,OAAO,CAACiE,KAAR,CAAc,gBAAd,EAAgCD,GAAhC;AACArD,EAAAA,OAAO,CAACuD,IAAR,CAAa,CAAb;AACD,CAJD;AAMAvD,OAAO,CAACoD,EAAR,CAAW,oBAAX,EAAkCC,GAAD;AAC/B;AACAhE,EAAAA,OAAO,CAACiE,KAAR,CAAc,gBAAd,EAAgCD,GAAhC;AACArD,EAAAA,OAAO,CAACuD,IAAR,CAAa,CAAb;AACD,CAJD;;;;"}